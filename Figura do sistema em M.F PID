% Limpa a tela, as variáveis e fecha gráficos anteriores
clc;
clear;
close all;

%% 1. Definição da Planta REAL e dos Ganhos do PID CORRIGIDOS

% Planta original de 2ª ordem com seu ganho real
num2 = 8.56e10;
den2 = [1, 5.1894, 31.64];
G2 = tf(num2, den2);

% Ganhos do PID desejados (calculados para uma planta com ganho 1)
Kp_desejado = 334.26;
Ki_desejado = 1836;
Kd_desejado = 42.81;

% Ganho da planta que será "absorvido" pelo controlador
Ganho_Planta = 8.56e10;

% Ganhos REAIS do controlador (escalonados pelo ganho da planta)
Kp = Kp_desejado / Ganho_Planta;
Ki = Ki_desejado / Ganho_Planta;
Kd = Kd_desejado / Ganho_Planta;

% Cria a função de transferência do controlador PID com os ganhos corretos
Gc_pid = tf([Kd, Kp, Ki], [1, 0]);

%% 2. Montagem e Fechamento da Malha

% Função de malha aberta com o controlador PID e a planta REAL
L = Gc_pid * G2;

% Fecha a malha do sistema (realimentação unitária)
T = feedback(L, 1);

% Exibe as funções de transferência para verificação
disp('Planta Original G2(s):');
disp(G2);
disp('Controlador PID com Ganhos Escalonados Gc(s):');
disp(Gc_pid);
disp('Sistema de Malha Fechada Final T(s):');
disp(T);

%% 3. Simulação e Análise
amplitude_degrau = 1.8;
tempo_final = 5; % Simula por 5 segundos para ver a resposta completa
t_sim = 0:0.01:tempo_final;

% Calcula a resposta ao degrau do sistema em malha fechada
[y, t] = step(T, t_sim);
y_escalado = y * amplitude_degrau;

% Análise de desempenho da resposta final
info = stepinfo(y_escalado, t, 'SettlingTimeThreshold', 0.02);
fprintf('\n--- Análise de Desempenho do Sistema Final com PID ---\n');
fprintf('Overshoot Desejado: ~10%%\n');
fprintf('Overshoot Real: %.2f%%\n\n', info.Overshoot);
fprintf('Tempo de Acomodação (2%%) Desejado: ~1.0s\n');
fprintf('Tempo de Acomodação (2%%) Real: %.4fs\n\n', info.SettlingTime);
fprintf('Valor Final Desejado: %.2f\n', amplitude_degrau);
fprintf('Valor Final Real: %.4f\n', y_escalado(end));
fprintf('--------------------------------------------------\n');

%% 4. Plot do Gráfico
figure;
hold on;

% Plota a resposta ao degrau escalada
plot(t, y_escalado, 'b-', 'LineWidth', 2, 'DisplayName', 'Resposta com Controlador PID');

% Adiciona a linha de referência do degrau de entrada
yline(amplitude_degrau, 'k:', 'LineWidth', 1.5, 'DisplayName', 'Entrada Degrau (1.8)');

% Configuração do Gráfico
title('Resposta ao Degrau com Projeto PID Final');
xlabel('Tempo (segundos)');
ylabel('Amplitude de Saída');
grid on;
legend('show', 'Location', 'southeast');
ylim([0, amplitude_degrau * 1.2]); % Ajusta o eixo Y para uma boa visualização
hold off;
